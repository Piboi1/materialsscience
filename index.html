<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>3D Crystal Block Dislocations</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
  <h2>3D Crystal Block: Edge vs Screw Dislocation</h2>

  <label for="dislocationType">Dislocation Type:</label>
  <select id="dislocationType">
    <option value="Edge">Edge</option>
    <option value="Screw">Screw</option>
  </select>

  <label for="dislocationPosition">Dislocation X Position:</label>
  <input type="range" id="dislocationPosition" min="2" max="8" step="0.1" value="5">

  <div id="plot" style="width:90%;max-width:900px;height:600px;"></div>

  <script>
    const nx = 20; // atoms along x
    const ny = 10; // atoms along y
    const nz = 5;  // planes along z
    const b = 1.0; // Burgers vector magnitude

    // Generate lattice coordinates
    function generateLattice() {
      let X = [], Y = [], Z = [];
      for (let k = 0; k < nz; k++) {
        for (let j = 0; j < ny; j++) {
          for (let i = 0; i < nx; i++) {
            X.push(i);
            Y.push(j);
            Z.push(k);
          }
        }
      }
      return {X, Y, Z};
    }

    function edgeDisplacement(X, dislocX) {
      return X.map(xi => (xi >= dislocX ? b : 0));
    }

    function screwDisplacement(X, Y, dislocX) {
      return X.map((xi, idx) => b/(2*Math.PI) * Math.atan(xi - dislocX));
    }

    function updatePlot() {
      const type = document.getElementById("dislocationType").value;
      const dislocX = parseFloat(document.getElementById("dislocationPosition").value);
      const lattice = generateLattice();

      let Z_new;
      if (type === "Edge") {
        // Edge: extra half-plane along x >= dislocX
        const dz = edgeDisplacement(lattice.X, dislocX);
        Z_new = lattice.Z.map((zi, idx) => zi + dz[idx]);
      } else {
        // Screw: helical twist around dislocation line
        const dz = screwDisplacement(lattice.X, lattice.Y, dislocX);
        Z_new = lattice.Z.map((zi, idx) => zi + dz[idx]);
      }

      const trace = {
        x: lattice.X,
        y: lattice.Y,
        z: Z_new,
        mode: 'markers',
        type: 'scatter3d',
        marker: {size: 4, color: Z_new, colorscale: 'Viridis'}
      };

      const layout = {
        title: `${type} Dislocation at X = ${dislocX.toFixed(2)}`,
        scene: {
          xaxis: {title: 'X (Slip direction)'},
          yaxis: {title: 'Y (Width)'},
          zaxis: {title: 'Z (Stacking planes)'},
          camera: {eye: {x: 1.5, y: 1.5, z: 1.5}}
        }
      };

      Plotly.newPlot('plot', [trace], layout);
    }

    // Initial plot
    updatePlot();

    // Event listeners
    document.getElementById("dislocationType").addEventListener("change", updatePlot);
    document.getElementById("dislocationPosition").addEventListener("input", updatePlot);
  </script>
</body>
</html>
